# JIT-компилятор
## Введение
Данный отчет представляет собой описание разработки JIT (Just-In-Time) компилятора для моего собственного [языка программирования](https://github.com/mr-gukas/MyLanguage).  Также в процессе разработки я работал с написанным мною [виртуальным процессором](https://github.com/mr-gukas/MyCPU), который представляет собой альтернативный способ исполнения программы. Целью моей работы было изучение JIT-компиляции, а также сравнение производительности между исполнением программы через JIT-компилятор и виртуальным процессором (далее встречаются как x86 и y86 соответственно).

Особенность JIT (Just-in-time) компилятора состоит в том, что результат трансляции - бинарный код, содержащий инструкции архитектуры, в которую происходит трансляция, исполняется сразу же после процесса контекстно-ориентированной трансляции(см. ниже). Для этого бинарный код сохраняется в массиве и вызывается в качестве функции.
## Контекстно-Ориентированная трансляция 
Объясним сначала понятие абстрактное синтаксическое дерево (AST):

AST (Abstract Syntax Tree) – это структура данных, представляющая синтаксическую структуру программы. После выполнения фронтенда моего языка программирования, программа преобразуется в AST. AST представляет собой дерево, где каждый узел соответствует определенному элементу программы (например, оператору, выражению или объявлению переменной), а дочерние узлы представляют его подэлементы. AST обычно используется в компиляторах для анализа и преобразования программы перед ее исполнением.

![AST](img/ast.png)*Пример AST программы, высчитывающий n-ое число Фибоначчи, где n - введенное пользователем число*

Примечание: Подробнее о структуре используемого мною AST можно прочитать [тут](https://github.com/dodokek/LanguageStandart).

Контекстно-ориентированная трансляция (или COT - Context-Oriented Translation) - это процесс преобразования программы из одной формы в другую, учитывая контекст, в котором она находится. Контекст в данном случае относится к семантическим, синтаксическим или структурным свойствам программы.

В контекстно-ориентированной трансляции важным элементом является анализ программы и понимание ее структуры и семантики. Для этого обычно используется абстрактное синтаксическое дерево (AST), которое представляет программу в виде иерархической структуры узлов. AST содержит информацию о конструкциях языка программирования, выражениях, операторах и других элементах программы.

В процессе контекстно-ориентированной трансляции происходит обход AST и преобразование его узлов с учетом контекста программы. Такое преобразование может включать оптимизации, проверки типов, генерацию промежуточного кода или генерацию кода на другом языке (например, компиляцию в машинный код).

Примером контекстно-ориентированной трансляции может быть преобразование высокоуровневого кода на языке программирования в оптимизированный машинный код для конкретного процессора. В этом случае трансляция учитывает контекст процессора, его возможности и особенности архитектуры, чтобы сгенерировать оптимальный код.

В случае моего JIT компилятора, контекстно-ориентированная трансляция происходит за один проход по AST. Во время этого прохода, когда AST читается последовательно, заполняется таблица имен, содержащая информацию о переменных, функциях и других элементах программы. Таблица имен позволяет JIT компилятору эффективно генерировать исполняемый код, учитывая контекст программы.

## Трансляция инструкций
Рассмотрим как транслировались инструкции в y86 (виртуальный процессор) и в x86:
### PUSH 
#### PUSH IMM 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` PUSH IMM  ```     | <p style="text-align: left;"> ``` mov rdi, IMM ``` <br> ``` push rdi ```  </p>  |  


#### PUSH REG 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` PUSH REG  ```     | <p style="text-align: left;"> ``` push r_x ```   </p>          |  


#### PUSH [IMM] 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` PUSH [IMM]  ```     | <p style="text-align: left;"> ``` mov rdi, qword IMM  ``` <br> ``` push rdi ```   </p>          |  

#### PUSH [REG] 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` PUSH [REG]  ```     | <p style="text-align: left;"> ``` mov rdi, qword [r_x]  ``` <br> ``` push rdi ```   </p>          |  


#### PUSH [IMM+REG] 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` PUSH [IMM+REG]  ```     | <p style="text-align: left;"> ``` mov rdi,  qword [r_x + IMM]  ``` <br> ``` push rdi ```   </p>          |  


### POP
#### POP [IMM]
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` POP [IMM]  ```     | <p style="text-align: left;"> ``` pop rdi ``` <br> ``` mov [IMM], rdi ```  </p>  |  


#### POP [REG] 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` POP [REG]  ```     | <p style="text-align: left;"> ``` pop rdi ``` <br> ``` mov [r_x], rdi ```  </p>  |  


#### POP REG 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` POP REG  ```     | <p style="text-align: left;"> ``` pop r_x ```   </p>          |  


#### POP [IMM+REG] 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` PUSH [IMM+REG]  ```     | <p style="text-align: left;"> ``` pop rdi ``` <br> ``` mov [r_x + IMM],  rdi ```   </p>          |  

### Математические операции
#### ADD
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` ADD  ```     | <p style="text-align: left;"> ``` add rsi, rdi ```   </p>          |  

#### SUB 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` SUB  ```     | <p style="text-align: left;"> ``` sub rsi, rdi ```   </p>          |  

#### MUL 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` MUL  ```     |<p style="text-align: left;"> ``` mov r10, rax ``` <br> ``` mov rax, rsi ```  <br> ``` mul rdi ``` <br> ``` push rax ``` <br> ``` mov rax, r10 ``` </p> |  

#### DIV 
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` DIV  ```     |<p style="text-align: left;"> ``` mov r10, rax ``` <br> ``` mov rax, rsi ```  <br> ``` push rdx ``` <br> ``` xorrdx, rdx ``` <br> ``` div rdi ``` <br> ``` pop rdx ``` <br> ``` push rax``` <br> ``` mov rax, r10 ``` </p> |  


####  SQRT
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` SQRT  ```     |<p style="text-align: left;"> ``` movsd xmm0, qword [rsp] ``` <br> ``` sqrtpd xmm0, xmm0 ```  <br> ``` movsd qword [rsp], xmm0 ``` </p> |  

#### Оператор сравнения <
|   y86       | x86               | 
| ------      | :---------------: | 
| ``` ISBT  ```     |<p style="text-align: left;"> ``` cmp rdi, rsi ``` <br> ``` jl less ```  <br> ``` push 1 ``` <br> ``` jmp done ``` <br> ``` less: ``` <br> ``` push 0 ``` <br> ``` done: ``` </p> |  

*Примечание: Перед началом этих опрераций происходит перемещание значений операндов из стека в регистры rdi, rsi. Результат операции перемещается в стек.

### Прыжки








